<div class="container-seven-large" style="background-color: white">
  <div id="page-controls">
    <h1>Trainings</h1>
    <div id="page-buttons">
      <% if params[:user] %>
        <%= simple_form_for :search, url: trainings_path, method: 'GET' do |f| %>
          <% if params[:search].present? %>
            <%= f.input :title, placeholder: 'Search', label: false, input_html: {value: params[:search][:title]} %>
            <%= link_to trainings_path, class: 'search-close' do %>
              <i class="far fa-times-circle"></i>
            <% end %>
          <% else %>
            <%= f.input :title, placeholder: 'Search', label: false %>
          <% end %>
          <%= f.input :user, as: :hidden, input_html: { value: params[:user] } %>
          <%= hidden_field_tag :page, 1 %>
        <% end %>
      <% else %>
        <%= simple_form_for :search, url: trainings_path, method: 'GET' do |f| %>
          <% if params[:search].present? %>
            <%= f.input :title, placeholder: 'Search', label: false, input_html: {value: params[:search][:title]} %>
          <% else %>
            <%= f.input :title, placeholder: 'Search', label: false %>
          <% end %>
          <%= hidden_field_tag :page, 1 %>
          <% if params[:search] %>
            <%= link_to trainings_path, class: 'search-close' do %>
              <i class="far fa-times-circle"></i>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
      <% if (['super admin', 'admin', 'training manager'].include? current_user.access_level) %>
        <% link_to new_training_path do %>
          <!-- <button class="btn btn-edit-yellow">New Training</button> -->
        <% end %>
        <% last_update = OverviewTraining.all(filter: "{Builder Update} != ''").sort{|x,y| x['Builder Update'].to_date <=> y['Builder Update'].to_date}.first %>
        <%= link_to import_airtable_path, class: "btn btn-edit-yellow" do %>
        <div class='flex-row-between-centered'>
          <p data-toggle="tooltip" title="Last Update : <%= last_update['Builder Update'].to_time.strftime('%d/%m/%Y at %H:%M') %>" style="margin:0 1rem 0 0;font-size: 1.4rem !important;font-family: 'Arial', sans-serif !important;">Update All</p>
          <span class="iconify" data-icon="simple-icons:airtable" data-inline="false"></span>
        </div>
        <% end %>
      <% end %>
    </div>
  </div>
  <% if (['super admin', 'admin', 'training manager'].include? current_user.access_level) %>
    <div id="trainings_user_filter" class='flex-row-start-centered'>
      <% if params[:user].present? %>
        <%= link_to 'All', trainings_path, class: 'avatar-sm centered-item avatar_filter_all avatar_filter_all_unselected' %>
      <% else %>
        <%= link_to 'All', trainings_path, class: 'avatar-sm centered-item avatar_filter_all' %>
      <% end %>
      <% User.where.not(access_level: %w[sevener+ sevener]).each do |user| %>
        <% if (params[:user] == user.id&.to_s) || (params[:search] && params[:search][:user] == user.id&.to_s) %>
          <%= link_to trainings_path(user: user.id) do %>
            <% if user.picture.present? %>
              <img src="<%= user.picture %>" class='lazyload avatar-sm'>
            <% else %>
              <img src='<%= asset_path('empty-avatar.png', type: :image) %>' class='lazyload avatar-sm'>
            <% end %>
          <% end %>
        <% else %>
           <%= link_to trainings_path(user: user.id) do %>
            <% if user.picture.present? %>
              <img src="<%= user.picture %>" class='lazyload avatar-sm' style='opacity: 0.6;'>
            <% else %>
              <img src='<%= asset_path('empty-avatar.png', type: :image) %>' class='lazyload avatar-sm' style='opacity: 0.6;'>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  <% end %>
  <div class="trainings-title">
    <% if params[:search] %>
      <h3 class="training-update-text">Search</h3>
      <%= render 'search', trainings: @trainings %>
    <% elsif params[:completed] %>
      <h3 class="training-update-text">Completed</h3>
      <%= render_async index_completed_path(user: params[:user])%>
    <% else %>
      <h3 class="training-update-text">Upcoming</h3>
      <div class="trainings-row">
        <%= render_async index_upcoming_path(user: params[:user]) %>
      </div>
      <% if ['super admin', 'admin', 'training manager'].include?(current_user.access_level) %>
        <h3 class="training-update-text">To Schedule</h3>
        <div class="trainings-row">
          <%= render 'index_to_date', trainings: @trainings %>
        </div>
        <h3 class="training-update-text">To Staff</h3>
        <div class="trainings-row">
          <%= render 'index_to_staff', trainings: @trainings %>
        </div>
        <h3 class="training-update-text">Home</h3>
        <div class="trainings-row">
          <%= render 'index_home', trainings: @trainings %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  sliders = document.querySelectorAll('.trainings-row');
  sliders.forEach((slider) => {
    isDown = false;
    let startX;
    let scrollLeft;

    slider.addEventListener('mousedown', (e) => {
      isDown = true;
      slider.classList.add('active');
      startX = e.pageX - slider.offsetLeft;
      scrollLeft = slider.scrollLeft;
    });
    slider.addEventListener('mouseleave', () => {
      isDown = false;
      slider.classList.remove('active');
    });
    slider.addEventListener('mouseup', () => {
      isDown = false;
      slider.classList.remove('active');
    });
    slider.addEventListener('mousemove', (e) => {
      if(!isDown) return;
      e.preventDefault();
      const x = e.pageX - slider.offsetLeft;
      const walk = (x - startX) * 3; //scroll-fast
      slider.scrollLeft = scrollLeft - walk;
      console.log(walk);
    });
  })
</script>
