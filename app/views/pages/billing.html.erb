<div class="container-seven-large">
  <div id="page-controls">
    <h1>Billing</h1>
    <div id="page-buttons">
      <% sevener = Sevener.all(filter: "{Builder_id} = '#{current_user.id}'").first %>
      <% if sevener.present? && [sevener["Attestation sur l'honneur"],sevener['CV (sans coordonnées)'],sevener['CNI'],sevener['Carte vitale'],sevener['RIB']].all?{|x| x.present?} %>
        <p>Kit Sevener Complete</p>
      <% else %>
        <p>Kit Sevener Incomplete</p>
      <% end %>
    </div>
  </div>
  <div id='billing-index'>
    <% to_pay = [] %>
    <% paid = [] %>
    <% Training.joins(sessions: :session_trainers).where(sessions: {session_trainers: {user_id: current_user.id}}).uniq.each do |training| %>
      <%# intervention = OverviewNumbersSevener.all.select{|x| x['Training_id'] == training.id && x['User_id'] == current_user.id}.first %>
      <%# intervention = OverviewNumbersSevener.all(filter: "Training_id = '#{training.id}'" && "User_id = '#{current_user.id}'").first %>
      <% intervention = OverviewNumbersSevener.all(filter: "Training_id = '#{training.id}'") %>
      <% if intervention.present? %>
        <% intervention = intervention.select{|x| x['User_id'] == current_user.id}.first %>
        <% if intervention['Total Due (excl. VAT)'].to_f - intervention['Total Paid'].to_f <= 0 %>
          <% paid << {training: training, intervention: intervention} %>
        <% else %>
          <% to_pay << {training: training, intervention: intervention} %>
        <% end %>
      <% end %>
    <% end %>
    <div class='billing-index-category'>
      <h2>To do</h2>
     <table class='invoices-to-do'>
      <tr>
        <th>Training</th>
        <th>Date</th>
        <th>Status</th>
        <th>Invoices</th>
        <th>Total Paid</th>
        <th></th>
      </tr>
      <% if to_pay.empty? %>
        <div class="billing-card">
          <div class="billing-card-title">
            <p>No training in this category</p>
          </div>
        </div>
      <% end %>
      <% to_pay.each do |hash| %>
        <% training, intervention = hash[:training], hash[:intervention] %>
        <% invoices = intervention['Invoices Sevener'] %>
        <% if invoices.nil? %>
          <% invoices = [] %>
        <% end %>
        <tr>
          <td>
            <% if invoices.count != 0 %>
              <a class='btn-link'><i class="fas fa-angle-down"></i> <p><b><%= training.title %></b></p></a>
            <% else %>
              <a class='btn-link'><i class="fas fa-angle-down" style='color: rgba(0,0,0,0);'></i> <p><b><%= training.title %></b></p></a>
            <% end %>
          </td>
          <td>Date</td>
          <td>
            <% if training.end_time.present? && training.end_time < Date.today %>
            <div class="completed-btn">
              <p>Completed</p>
            </div>
            <% else %>
            <div class="ongoing-btn">
              <p>Ongoing</p>
            </div>
            <% end %>
          </td>
          <td>
            <p><%= invoices.count %></p>
          </td>
          <td>
            <% total_due = intervention['Total Due (excl. VAT)'].to_f - intervention['Total Paid'].to_f %>
            <p><%= intervention['Total Paid'].to_f %>€</p>
          </td>
          <td>
            <% unless total_due == 0 %>
              <% if training.end_time.present? && training.end_time <= Date.today %>
                <%= link_to invoice_form_path(training), class: 'btn btn-edit-green btn-icon', data: {toggle:'tooltip'}, title: 'Submit an invoice' do %>
                  <i class="fas fa-file-invoice-dollar"></i>
                <% end %>
              <% else %>
                <a class='btn btn-edit-grey btn-icon disabled' style='opacity: .25;'>
                  <i data-toggle='tooltip' title='You may only send invoices for completed trainings.' class="fas fa-file-invoice-dollar"></i>
                </a>
              <% end %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </table>
    </div>
    <div class='billing-index-category'>
      <h2>Completed</h2>
        <table class='completed'>
        <tr>
          <th>Training</th>
          <th>Date</th>
          <th>Invoices</th>
          <th>Total Due</th>
          <th></th>
          <th></th>
        </tr>
      <% if paid.empty? %>
        <div class="billing-card">
          <div class="billing-card-title">
            <p>No training in this category</p>
          </div>
        </div>
      <% end %>
      <% paid.each do |hash| %>
        <% training, intervention = hash[:training], hash[:intervention] %>
        <% invoices = intervention['Invoices Sevener'] %>
        <% if invoices.nil? %>
          <% invoices = [] %>
        <% end %>
        <tr>
          <td>
            <% if invoices.count != 0 %>
              <a class='btn-link'><i class="fas fa-angle-down"></i> <p><b><%= training.title %></b></p></a>
            <% else %>
              <a class='btn-link'><i class="fas fa-angle-down" style='color: rgba(0,0,0,0);'></i> <p><b><%= training.title %></b></p></a>
            <% end %>
          </td>
          <td>Date</td>
          <td>
            <p><%= invoices.count %></p>
          </td>
          <td>
            <% total_due = intervention['Total Due (excl. VAT)'].to_f - intervention['Total Paid'].to_f %>
            <p><%= total_due %>€</p></td>
          <td>
            <% unless total_due == 0 %>
              <%= link_to invoice_form_path(training), class: 'btn btn-edit-green btn-icon invisible', data: {toggle:'tooltip'}, title: 'Submit an invoice' do %>
                <i class="fas fa-file-invoice-dollar"></i>
              <% end %>
            <% end %>
          </td>
          <td></td>
        </tr>
      <% end %>
    </table>
    </div>
  </div>
</div>

<script>
  const allCarets = document.querySelectorAll('.btn-link');
  allCarets.forEach(element => {
    element.addEventListener('click', event => {
      element.querySelector('.fas').classList.toggle('rotated180');
    })
  })
</script>
<script>
  $('.btn-link').on('click', function(){
    if($(this).parent().parent().parent().children('.collapse').hasClass('show')) {
      $(this).parent().parent().parent().children('.collapse').collapse('hide');
    } else {
      $(this).parent().parent().parent().children('.collapse').collapse('show');
    }
  });
</script>
